name: "üßπ Auto Fix & Format (Ruff)"

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - ".github/workflows/auto-fix.yml"
      - ".github/workflows/lint.yml"
      - "**/*.md"
      - "**/*.txt"

jobs:
  ruff-fix-and-format:
    name: "Run Ruff Fix & Format"
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    if: github.actor != 'github-actions[bot]'

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # n√©cessaire pour cr√©er une nouvelle branche

      - name: "Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "Install Ruff"
        run: pip install ruff

      - name: "Run Ruff lint & auto-fix"
        run: |
          if [ -d "src" ]; then
            TARGETS="src tests"
          else
            TARGETS="."
          fi
          echo "üîç Checking targets: $TARGETS"
          ruff check $TARGETS --fix --exit-zero

      - name: "Format code"
        run: |
          if [ -d "src" ]; then
            TARGETS="src tests"
          else
            TARGETS="."
          fi
          echo "üßπ Formatting targets: $TARGETS"
          ruff format $TARGETS

      - name: "Show diff summary"
        run: git diff --stat || echo "No changes detected."

      - name: "Check if changes exist"
        id: changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: "Configure Git identity"
        if: steps.changes.outputs.changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: "Create auto-fix branch and commit"
        if: steps.changes.outputs.changes == 'true'
        run: |
          BRANCH_NAME="auto-fix/ruff-$(date +'%Y%m%d-%H%M%S')"
          git checkout -b $BRANCH_NAME
          git add .
          git commit -m "style: auto-fix and format code with Ruff"
          git push origin $BRANCH_NAME
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Create pull request"
        if: steps.changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "style: auto-fix and format code with Ruff"
          body: |
            ü§ñ Ce PR a √©t√© g√©n√©r√© automatiquement par le workflow **Auto Fix & Format (Ruff)**.

            Il applique les corrections et la mise en forme de code selon les r√®gles d√©finies par Ruff.
          base: main
          commit-message: "style: auto-fix and format code with Ruff"
